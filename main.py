import requests
import urllib3
import os
import re
import time
import json
import sys
import random
from tqdm import tqdm
from concurrent.futures import ThreadPoolExecutor
from bs4 import BeautifulSoup
from threading import Lock

# (Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
WC_API_URL = os.environ.get("WC_API_URL")
WC_CONSUMER_KEY = os.environ.get("WC_CONSUMER_KEY")
WC_CONSUMER_SECRET = os.environ.get("WC_CONSUMER_SECRET")
BASE_URL = "https://panel.eways.co"
AUT_COOKIE_VALUE = os.environ.get("EWAYS_AUTH_TOKEN")
SOURCE_CATS_API_URL = f"{BASE_URL}/Store/GetCategories"
PRODUCT_LIST_URL_TEMPLATE = f"{BASE_URL}/Store/List/{{category_id}}/2/2/1/0/0/10000000000?page={{page}}" # ØµÙØ­Ù‡ Ø¨Ù†Ø¯ÛŒ Ø¨Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ±

# (ØªÙ…Ø§Ù… ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± Ù…Ø«Ù„ get_session, get_and_parse_categories, get_products_from_category_page Ùˆ ... Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯)
# ...
# ÙÙ‚Ø· ØªØ§Ø¨Ø¹ main Ø±Ø§ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ø² Ù†Ù‚Ø´Ù‡ ØµØ­ÛŒØ­ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø¯.

def main():
    if not all([WC_API_URL, WC_CONSUMER_KEY, WC_CONSUMER_SECRET, AUT_COOKIE_VALUE]):
        print("âŒ ÛŒÚ©ÛŒ Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ Ø¶Ø±ÙˆØ±ÛŒ (WC_* ÛŒØ§ EWAYS_AUTH_TOKEN) ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        return

    session = get_session()
    
    source_categories = get_and_parse_categories(session)
    if source_categories is None: return

    # Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.
    # Ø§ÛŒÙ† ID Ù‡Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ø³Ø§ÛŒØª Ù…Ø¨Ø¯Ø§ Ø¨Ø§Ø´Ù†Ø¯
    selected_ids = [4285, 16778] # Ù…Ø«Ø§Ù„: ID Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ´ÛŒ Ùˆ Ù„Ù¾â€ŒØªØ§Ù¾
    filtered_categories = [c for c in source_categories if c['id'] in selected_ids]
    print(f"\nâœ… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†ØªØ®Ø¨: {[c['name'] for c in filtered_categories]}")
    if not filtered_categories:
        print("âŒ Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù… Ø§Ø² Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†ØªØ®Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯Ù†Ø¯.")
        return

    # *** Ù…Ø±Ø­Ù„Ù‡ Ú©Ù„ÛŒØ¯ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ***
    # 1. Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ÙˆÙˆÚ©Ø§Ù…Ø±Ø³ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    # 2. ÛŒÚ© Ù†Ù‚Ø´Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø§Ø² ID Ø³Ø§ÛŒØª Ù…Ø¨Ø¯Ø§ Ø¨Ù‡ ID Ø³Ø§ÛŒØª ÙˆÙˆÚ©Ø§Ù…Ø±Ø³ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    category_mapping = transfer_categories_to_wc(filtered_categories)
    if not category_mapping:
        print("âŒ Ù†Ú¯Ø§Ø´Øª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙˆÙˆÚ©Ø§Ù…Ø±Ø³ Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯. Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø®Ø§ØªÙ…Ù‡ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯.")
        return

    products = get_all_products(session, filtered_categories)
    if not products:
        print("âœ… Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§ØªÙ…Ù‡ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯.")
        return

    stats = {'created': 0, 'updated': 0, 'lock': Lock()}
    print(f"\nğŸš€ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ø§Ø±Ø³Ø§Ù„ {len(products)} Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ ÙˆÙˆÚ©Ø§Ù…Ø±Ø³...")
    with ThreadPoolExecutor(max_workers=5) as executor:
        # Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø² category_mapping ØµØ­ÛŒØ­ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        args_list = [(p, stats, category_mapping) for p in products]
        list(tqdm(executor.map(process_product_wrapper, args_list), total=len(products), desc="Ø§Ø±Ø³Ø§Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª"))

    print("\n===============================")
    print(f"ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡: {len(products)}")
    print(f"ğŸŸ¢ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡: {stats['created']}")
    print(f"ğŸ”µ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯Ù‡: {stats['updated']}")
    print("===============================\nØªÙ…Ø§Ù…!")


if __name__ == "__main__":
    # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯ Ú©Ù‡ ØªÙ…Ø§Ù… ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± Ø¯Ø± ÙØ§ÛŒÙ„ Ø´Ù…Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯
    main()
